-- V3: Students, Attendance, Grades, Enrollments
-- Required for W5: Churn Prediction + Report Generation

-- ===== Students =====
CREATE TABLE IF NOT EXISTS students (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id),
  branch_id UUID REFERENCES branches(id) NOT NULL,
  name TEXT NOT NULL,
  grade VARCHAR(10) NOT NULL, -- '小3', '國1', '高2' etc.
  phone VARCHAR(20), -- parent phone
  parent_name TEXT,
  enrolled_at TIMESTAMP DEFAULT NOW(),
  status VARCHAR(20) DEFAULT 'active', -- active | paused | dropped
  risk_score INTEGER DEFAULT 0, -- 0-100, AI calculated
  risk_factors JSONB DEFAULT '[]',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_students_tenant ON students(tenant_id);
CREATE INDEX IF NOT EXISTS idx_students_branch ON students(branch_id);
CREATE INDEX IF NOT EXISTS idx_students_status ON students(status);

-- ===== Enrollments (student ↔ course) =====
CREATE TABLE IF NOT EXISTS enrollments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id),
  student_id UUID REFERENCES students(id) NOT NULL,
  course_name TEXT NOT NULL, -- '國中數學', '高中物理' etc.
  fee_monthly INTEGER NOT NULL, -- NTD
  day_of_week VARCHAR(20), -- '二四', '一三五'
  time_slot VARCHAR(20), -- '18:30-20:30'
  status VARCHAR(20) DEFAULT 'active', -- active | completed | dropped
  started_at TIMESTAMP DEFAULT NOW(),
  ended_at TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_enrollments_student ON enrollments(student_id);
CREATE INDEX IF NOT EXISTS idx_enrollments_tenant ON enrollments(tenant_id);

-- ===== Attendance =====
CREATE TABLE IF NOT EXISTS attendance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id),
  student_id UUID REFERENCES students(id) NOT NULL,
  enrollment_id UUID REFERENCES enrollments(id),
  date DATE NOT NULL,
  status VARCHAR(10) NOT NULL DEFAULT 'present', -- present | absent | late | excused
  note TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_attendance_student ON attendance(student_id);
CREATE INDEX IF NOT EXISTS idx_attendance_date ON attendance(date);
CREATE INDEX IF NOT EXISTS idx_attendance_tenant ON attendance(tenant_id);

-- ===== Grades / Scores =====
CREATE TABLE IF NOT EXISTS grades (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id),
  student_id UUID REFERENCES students(id) NOT NULL,
  enrollment_id UUID REFERENCES enrollments(id),
  exam_name TEXT NOT NULL, -- '第一次段考', '小考3', '模擬考'
  exam_type VARCHAR(20) DEFAULT 'quiz', -- quiz | midterm | final | mock
  score NUMERIC(5,1) NOT NULL, -- 0-100
  full_score NUMERIC(5,1) DEFAULT 100,
  date DATE NOT NULL,
  note TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_grades_student ON grades(student_id);
CREATE INDEX IF NOT EXISTS idx_grades_date ON grades(date);
CREATE INDEX IF NOT EXISTS idx_grades_tenant ON grades(tenant_id);

-- ===== Seed demo data (愛學館) =====

-- 8 students
INSERT INTO students (id, tenant_id, branch_id, name, grade, phone, parent_name, enrolled_at, status) VALUES
  ('aaaa0001-0000-0000-0000-000000000001', '11111111-1111-1111-1111-111111111111', 'a1b2c3d4-e5f6-1a2b-8c3d-4e5f6a7b8c9d', '陳小明', '國2', '0912345678', '陳媽媽', '2025-09-01', 'active'),
  ('aaaa0002-0000-0000-0000-000000000002', '11111111-1111-1111-1111-111111111111', 'a1b2c3d4-e5f6-1a2b-8c3d-4e5f6a7b8c9d', '林小華', '國3', '0923456789', '林爸爸', '2025-09-01', 'active'),
  ('aaaa0003-0000-0000-0000-000000000003', '11111111-1111-1111-1111-111111111111', 'a1b2c3d4-e5f6-1a2b-8c3d-4e5f6a7b8c9d', '王小美', '高1', '0934567890', '王媽媽', '2025-09-01', 'active'),
  ('aaaa0004-0000-0000-0000-000000000004', '11111111-1111-1111-1111-111111111111', 'a1b2c3d4-e5f6-1a2b-8c3d-4e5f6a7b8c9d', '張小強', '國1', '0945678901', '張爸爸', '2025-10-15', 'active'),
  ('aaaa0005-0000-0000-0000-000000000005', '11111111-1111-1111-1111-111111111111', 'a1b2c3d4-e5f6-1a2b-8c3d-4e5f6a7b8c9d', '李小龍', '國2', '0956789012', '李媽媽', '2025-09-01', 'active'),
  ('aaaa0006-0000-0000-0000-000000000006', '11111111-1111-1111-1111-111111111111', 'a1b2c3d4-e5f6-1a2b-8c3d-4e5f6a7b8c9d', '黃小芳', '小5', '0967890123', '黃爸爸', '2025-09-01', 'active'),
  ('aaaa0007-0000-0000-0000-000000000007', '11111111-1111-1111-1111-111111111111', 'a1b2c3d4-e5f6-1a2b-8c3d-4e5f6a7b8c9d', '劉小偉', '高2', '0978901234', '劉媽媽', '2025-08-01', 'active'),
  ('aaaa0008-0000-0000-0000-000000000008', '11111111-1111-1111-1111-111111111111', 'a1b2c3d4-e5f6-1a2b-8c3d-4e5f6a7b8c9d', '趙小雪', '國3', '0989012345', '趙爸爸', '2025-11-01', 'active')
ON CONFLICT DO NOTHING;

-- Enrollments
INSERT INTO enrollments (tenant_id, student_id, course_name, fee_monthly, day_of_week, time_slot, status) VALUES
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '國中數學', 4500, '二四', '18:30-20:30', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '國中英文', 4200, '一三五', '17:00-18:30', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '國中數學', 4500, '二四', '18:30-20:30', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '高中物理', 5000, '一三', '19:00-21:00', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '國中數學', 4500, '二四', '18:30-20:30', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '國中數學', 4500, '二四', '18:30-20:30', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '國中英文', 4200, '一三五', '17:00-18:30', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '國小數學', 3500, '三五', '16:00-17:30', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '高中物理', 5000, '一三', '19:00-21:00', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '高中數學', 5500, '二四', '19:00-21:00', 'active'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '國中英文', 4200, '一三五', '17:00-18:30', 'active')
ON CONFLICT DO NOTHING;

-- Attendance records (2 months: Jan-Feb 2026)
-- Student 陳小明: good attendance
INSERT INTO attendance (tenant_id, student_id, date, status) VALUES
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-01-07', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-01-09', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-01-14', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-01-16', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-01-21', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-01-23', 'late'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-02-04', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-02-06', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-02-11', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '2026-02-13', 'present');

-- Student 林小華: declining attendance (HIGH RISK)
INSERT INTO attendance (tenant_id, student_id, date, status) VALUES
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-01-07', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-01-09', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-01-14', 'absent'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-01-16', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-01-21', 'absent'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-01-23', 'absent'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-02-04', 'absent'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-02-06', 'excused'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-02-11', 'absent'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '2026-02-13', 'absent');

-- Student 李小龍: moderate decline (MED RISK)
INSERT INTO attendance (tenant_id, student_id, date, status) VALUES
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-01-07', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-01-09', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-01-14', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-01-16', 'late'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-01-21', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-01-23', 'absent'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-02-04', 'late'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-02-06', 'absent'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-02-11', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '2026-02-13', 'absent');

-- Other students: normal attendance (6-8 records each)
INSERT INTO attendance (tenant_id, student_id, date, status) VALUES
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '2026-01-06', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '2026-01-08', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '2026-01-13', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '2026-01-15', 'late'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '2026-02-03', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '2026-02-05', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '2026-02-10', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '2026-02-12', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '2026-01-07', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '2026-01-09', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '2026-01-14', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '2026-01-16', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '2026-02-04', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '2026-02-06', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '2026-02-11', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '2026-01-08', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '2026-01-10', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '2026-01-15', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '2026-01-17', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '2026-02-05', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '2026-02-07', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '2026-01-06', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '2026-01-08', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '2026-01-13', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '2026-01-15', 'absent'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '2026-02-03', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '2026-02-05', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '2026-02-10', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '2026-01-06', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '2026-01-08', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '2026-01-13', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '2026-01-15', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '2026-02-03', 'present'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '2026-02-05', 'late');

-- Grades
INSERT INTO grades (tenant_id, student_id, exam_name, exam_type, score, date) VALUES
  -- 陳小明: stable 75-85
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '小考1', 'quiz', 82, '2026-01-10'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '段考1', 'midterm', 78, '2026-01-20'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0001-0000-0000-0000-000000000001', '小考2', 'quiz', 85, '2026-02-07'),
  -- 林小華: declining 80→60→45 (HIGH RISK)
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '小考1', 'quiz', 80, '2026-01-10'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '段考1', 'midterm', 60, '2026-01-20'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0002-0000-0000-0000-000000000002', '小考2', 'quiz', 45, '2026-02-07'),
  -- 王小美: good 88-92
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '小考1', 'quiz', 92, '2026-01-10'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '段考1', 'midterm', 88, '2026-01-20'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0003-0000-0000-0000-000000000003', '小考2', 'quiz', 90, '2026-02-07'),
  -- 張小強: stable 70
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '小考1', 'quiz', 72, '2026-01-10'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '段考1', 'midterm', 68, '2026-01-20'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0004-0000-0000-0000-000000000004', '小考2', 'quiz', 71, '2026-02-07'),
  -- 李小龍: slight decline 75→65 (MED RISK)
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '小考1', 'quiz', 75, '2026-01-10'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '段考1', 'midterm', 70, '2026-01-20'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0005-0000-0000-0000-000000000005', '小考2', 'quiz', 65, '2026-02-07'),
  -- 黃小芳: good
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '小考1', 'quiz', 88, '2026-01-10'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0006-0000-0000-0000-000000000006', '段考1', 'midterm', 85, '2026-01-20'),
  -- 劉小偉: good
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '小考1', 'quiz', 78, '2026-01-10'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '段考1', 'midterm', 82, '2026-01-20'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0007-0000-0000-0000-000000000007', '小考2', 'quiz', 80, '2026-02-07'),
  -- 趙小雪: slight decline
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '小考1', 'quiz', 78, '2026-01-10'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa0008-0000-0000-0000-000000000008', '段考1', 'midterm', 72, '2026-01-20');
